#!/bin/bash
# scripts/create_ward_geojson_files.sh

BUCKET="lengo-geomapping"
WARD_NUM=1
BASE_PATH="database/africa/south_africa/johannesburg/johannesburg_custom_ward_${WARD_NUM}"

echo "=== Création et upload des 8 fichiers GeoJSON du Ward ${WARD_NUM} ==="

# Créer un dossier temporaire
TEMP_DIR="temp_ward_${WARD_NUM}_geojson"
mkdir -p ${TEMP_DIR}

# Fonction pour créer un fichier GeoJSON complet
create_geojson_file() {
    local subzone=$1
    local coords=$2
    local filename="polygon_custom_ward_${WARD_NUM}_subzone_${subzone}.geojson"
    
    # Note: les coordonnées doivent être dans un double tableau [[coords]]
    cat > "${TEMP_DIR}/${filename}" << EOF
{"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": {"type": "Polygon", "coordinates": [[${coords}]]}, "properties": {}}]}
EOF
    
    echo "✅ Créé: ${filename}"
}

# Créer les 8 fichiers GeoJSON
echo "Création des fichiers GeoJSON..."

# Subzone 1
create_geojson_file 1 '[-26.504336006601399, 27.8277779997549], [-26.500373999260599, 27.829811000877001], [-26.500075999907502, 27.829963998939402], [-26.495100179629532, 27.832517536209004], [-26.495100179629532, 27.826493549005814], [-26.496272998100299, 27.826649000750798], [-26.503501008564601, 27.8276070008624], [-26.504429994748399, 27.8277299957428], [-26.504336006601399, 27.8277779997549]'

# Subzone 2
create_geojson_file 2 '[-26.496879000865199, 27.846819997444999], [-26.496918519773899, 27.846892209408001], [-26.497180001256002, 27.84736999403], [-26.497574929498651, 27.848088609901499], [-26.495100179629532, 27.848088609901499], [-26.495100179629532, 27.843568921551814], [-26.496879000865199, 27.846819997444999]'

# Subzone 3
create_geojson_file 3 '[-26.4997299974413, 27.852009995764799], [-26.500289999883499, 27.8529199999581], [-26.5006410061774, 27.8533500018012], [-26.5011799986579, 27.854010002559601], [-26.5013860018625, 27.8542370013365], [-26.501394995982199, 27.854247997347301], [-26.502620003010701, 27.855600003937099], [-26.503421157760201, 27.856484572605002], [-26.503226332229399, 27.856603980989], [-26.502970241283599, 27.856759859579899], [-26.502613946976101, 27.8569157390701], [-26.502380125042698, 27.856960275296501], [-26.502157441212901, 27.857004812422201], [-26.501958996810199, 27.8571440040926], [-26.5018740000849, 27.8572030032161], [-26.5016780018383, 27.8573409987881], [-26.501242006913099, 27.857591002223099], [-26.501033001771599, 27.857734998071699], [-26.5008419992588, 27.857895001852899], [-26.500543999905599, 27.8579609986012], [-26.500317002028002, 27.857973000053899], [-26.499970998662601, 27.8580329974249], [-26.499762001615, 27.8581219997305], [-26.499607001661701, 27.858307001966601], [-26.499434000878399, 27.858503997561499], [-26.499297001755199, 27.8586180001206], [-26.499009999312001, 27.858742996891898], [-26.498783997883201, 27.858838000373499], [-26.498497002634501, 27.858891996568499], [-26.498151007363099, 27.858946000857301], [-26.4978710016454, 27.859029002886199], [-26.497698008056599, 27.8591070019867], [-26.497524999179301, 27.8591130022633], [-26.497310001855102, 27.8591190034394], [-26.4970890042541, 27.8591609990808], [-26.496898000841998, 27.859166002009399], [-26.4968089994357, 27.859136997074799], [-26.4966830044171, 27.859195996198299], [-26.4966250008431, 27.8592160007179], [-26.496501214559402, 27.859231675001901], [-26.496397068569902, 27.859228159552], [-26.496300727796299, 27.859204079304799], [-26.4962344846337, 27.8591197786549], [-26.496095998031901, 27.858848813821801], [-26.495981592576399, 27.858650099622398], [-26.495933414995001, 27.858493549237998], [-26.4959187056837, 27.858462786128801], [-26.495867179027002, 27.858355053642899], [-26.495746749912499, 27.858276770356699], [-26.495584174070299, 27.858258704775398], [-26.4953794443059, 27.8581924697068], [-26.495252997827599, 27.8581924697068], [-26.495156648960101, 27.858174405024901], [-26.495100179629532, 27.858146170095996], [-26.495100179629532, 27.848088609901499], [-26.497574929498651, 27.848088609901499], [-26.4997299974413, 27.852009995764799]'

# Subzone 4
create_geojson_file 4 '[-26.4907500024106, 27.834750000212399], [-26.490450000267199, 27.835069997882201], [-26.491111124039133, 27.836278303600899], [-26.485770364510664, 27.836278303600899], [-26.485770364510664, 27.825256924518104], [-26.495100179629532, 27.826493549005814], [-26.495100179629532, 27.832517536209004], [-26.4907500024106, 27.834750000212399]'

# Subzone 5
create_geojson_file 5 '[-26.494058999423199, 27.841666000785299], [-26.495100179629532, 27.843568921551814], [-26.495100179629532, 27.848088609901499], [-26.485770364510664, 27.848088609901499], [-26.485770364510664, 27.836278303600899], [-26.491111124039133, 27.836278303600899], [-26.494058999423199, 27.841666000785299]'

# Subzone 6
create_geojson_file 6 '[-26.485843869698801, 27.859750910276301], [-26.485770364510664, 27.859660440853471], [-26.485770364510664, 27.848088609901499], [-26.495100179629532, 27.848088609901499], [-26.495100179629532, 27.858146170095996], [-26.495060309086, 27.8581262346381], [-26.494801384376402, 27.858120219073001], [-26.494626768410601, 27.858120219073001], [-26.4944641835752, 27.8581804295832], [-26.494271502927401, 27.858312899720602], [-26.494157089378099, 27.8584152650525], [-26.4940563068531, 27.858483368013101], [-26.493934302126299, 27.858565799871801], [-26.493837954158199, 27.858613970258599], [-26.493693442997898, 27.858650099622398], [-26.493530867155801, 27.858698270908501], [-26.4933743068787, 27.858704294567598], [-26.493073237240001, 27.858692254444001], [-26.4928624829172, 27.858686229885699], [-26.492615607324399, 27.8586440840573], [-26.4923988284431, 27.858632034940499], [-26.492194106772601, 27.858680214320501], [-26.492121847145501, 27.858740424830799], [-26.492013458154499, 27.8588367647049], [-26.4918749625594, 27.858896984208499], [-26.4916822819117, 27.858975260300099], [-26.491429381760501, 27.859029454345901], [-26.4912607822593, 27.859047519027801], [-26.491110245641298, 27.859029454345901], [-26.491044010572601, 27.858993324981999], [-26.4909235805588, 27.858999348640999], [-26.490730891817201, 27.859017414222301], [-26.490526162052699, 27.8590956903139], [-26.490351546086899, 27.8591378361422], [-26.490225092414001, 27.8591257951194], [-26.4901106860592, 27.8591257951194], [-26.489960151239998, 27.859179990064501], [-26.48976143794, 27.859210094870001], [-26.4894904722075, 27.859240200574799], [-26.4893098316833, 27.859252248792298], [-26.489165321422298, 27.8592582661561], [-26.488894355689901, 27.859234184110299], [-26.488490919820102, 27.8592161194284], [-26.488316295760399, 27.859210094870001], [-26.488045330927299, 27.859210094870001], [-26.487894796107899, 27.859210094870001], [-26.487780389753201, 27.859240200574799], [-26.4876900663435, 27.8592703143736], [-26.487599741135199, 27.859294394620701], [-26.487074008258801, 27.8594972412047], [-26.486637401794599, 27.859647792211899], [-26.486276082075499, 27.859778267652999], [-26.4860860454347, 27.8598518330956], [-26.4859376536997, 27.859898916202098], [-26.485843869698801, 27.859750910276301]'

# Subzone 7
create_geojson_file 7 '[-26.4851899978201, 27.825179999557399], [-26.485770364510667, 27.825256924518104], [-26.485770364510667, 27.836278303600899], [-26.483171757659285, 27.836278303600899], [-26.479170239115199, 27.827053534692901], [-26.479620625891201, 27.825502204163499], [-26.479878001968199, 27.8244679973003], [-26.4851899978201, 27.825179999557399]'

# Subzone 8
create_geojson_file 8 '[-26.4775060391724, 27.845753621832198], [-26.477838281111801, 27.845760135621799], [-26.4784767080336, 27.845789451721899], [-26.478743804882701, 27.845805738444099], [-26.479196566768099, 27.845822025166399], [-26.480157465394701, 27.845822025166399], [-26.480156621830599, 27.8453062136109], [-26.480128516217999, 27.845138855174], [-26.480092999292498, 27.845018997128999], [-26.479580927118, 27.8441575536282], [-26.4792548590245, 27.843626142432601], [-26.478892002363999, 27.8430099971137], [-26.4787437131518, 27.842743479428101], [-26.478163082060501, 27.841422544415], [-26.4780812662374, 27.841214688607], [-26.478066090177901, 27.841176134670899], [-26.4820016610478, 27.839117591004101], [-26.483957049777999, 27.8380888529183], [-26.4838930009611, 27.837940998078601], [-26.483171757659285, 27.836278303600899], [-26.485770364510667, 27.836278303600899], [-26.485770364510667, 27.848088609901499], [-26.477242638515023, 27.848088609901499], [-26.476843002302601, 27.847339998941798], [-26.476452999606199, 27.846638999890001], [-26.476441094380998, 27.845802040431899], [-26.4764405493918, 27.845763864211001], [-26.4775060391724, 27.845753621832198]'

# Upload vers GCS
echo -e "\n=== Upload vers GCS ==="

# Upload de tous les fichiers
for i in {1..8}; do
    source_file="${TEMP_DIR}/polygon_custom_ward_${WARD_NUM}_subzone_${i}.geojson"
    dest_url="gs://${BUCKET}/${BASE_PATH}/polygon_custom_ward_${WARD_NUM}_subzone_${i}.geojson"
    
    if [ -f "$source_file" ]; then
        gcloud storage cp "$source_file" "$dest_url"
        echo "☁️  Uploadé: polygon_custom_ward_${WARD_NUM}_subzone_${i}.geojson"
    else
        echo "❌ Fichier non trouvé: $source_file"
    fi
done

# Vérification finale
echo -e "\n=== Vérification des fichiers uploadés ==="
gcloud storage ls "gs://${BUCKET}/${BASE_PATH}/" | grep "polygon_custom_ward_${WARD_NUM}_subzone_"

# Vérifier le format d'un fichier
echo -e "\n=== Vérification du format (subzone 1) ==="
gcloud storage cat "gs://${BUCKET}/${BASE_PATH}/polygon_custom_ward_${WARD_NUM}_subzone_1.geojson" | python -m json.tool | head -n 20

# Test rapide avec Python pour vérifier que Shapely peut lire le fichier
echo -e "\n=== Test de lecture avec Shapely ==="
python3 -c "
import json
from shapely.geometry import shape
# Lire le fichier local
with open('${TEMP_DIR}/polygon_custom_ward_${WARD_NUM}_subzone_1.geojson', 'r') as f:
    data = json.load(f)
poly = shape(data['features'][0]['geometry'])
print(f'✅ Polygone valide: {poly.is_valid}')
print(f'   Aire: {poly.area:.6f}')
print(f'   Périmètre: {poly.length:.6f}')
"

# Nettoyer les fichiers temporaires
echo -e "\n=== Nettoyage ==="
rm -rf ${TEMP_DIR}

echo -e "\n✅ Terminé! Les 8 fichiers GeoJSON ont été créés et uploadés vers:"
echo "   gs://${BUCKET}/${BASE_PATH}/"